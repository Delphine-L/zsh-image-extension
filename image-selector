# -*- mode: shell-script -*-
# vim: ft=zsh fdm=marker :


IMAGE_SELECTOR_DIR="${0:A:h}"

IMAGE_SELECTOR_SXIV="$IMAGE_SELECTOR_DIR/sxiv"
if [ ! -x "$IMAGE_SELECTOR_SXIV" ]; then
    if [ -n "$commands[sxiv]" ]; then
        IMAGE_SELECTOR_SXIV=sxiv
    else
        echo 'ERROR: sxiv not found in $PATH' 1>&2
        return 1
    fi
fi

W3MIMGDISPLAY=/usr/lib/w3m/w3mimgdisplay
if [ -x "$W3MIMGDISPLAY" ]; then
    IMAGE_PREVIEW_SCRIPT="$IMAGE_SELECTOR_DIR/image-preview"
    image-preview()
    {
        autoload -U split-shell-arguments
        setopt local_options nullglob

        # local variables for split-shell-arguments
        local reply REPLY REPLY2
        split-shell-arguments

        eval "reply=($reply)"

        local OUTPUT
        OUTPUT=`"$IMAGE_PREVIEW_SCRIPT" "$W3MIMGDISPLAY" $reply`
        if [ "$?" != "0" ]; then
            return $?
        fi

        "$W3MIMGDISPLAY" &> /dev/null <<EOF
$OUTPUT
EOF

        read -s -k
        zle clear-screen
    }
    zle -N image-preview
    bindkey ${IMAGE_PREVIEW_KEY:-'^X^O'} image-preview
fi

image-selector()
{
    autoload -U modify-current-argument
    autoload -U split-shell-arguments

    # local variables for split-shell-arguments
    local reply REPLY REPLY2

    local ARG
    local PREFIX

    ((--CURSOR))
    split-shell-arguments
    ((++CURSOR))

    ARG=${~reply[$REPLY]%% #}

    # read the file prefix with trailing slashes stripped
    [ -n "$ARG" ] && PREFIX=${ARG%%/#}

    # if it is a directory, use its contents; also, corner case
    [ -d "$PREFIX" ] || [ "$ARG" = "/" ] && PREFIX=${PREFIX}/

    local FILES
    FILES=(${PREFIX}*(-.N))
    [ -z "$FILES" ] && return

    local OLDIFS=$IFS
    local IFS="
"
    FILES=($($IMAGE_SELECTOR_SXIV -t -o -- $FILES 2> /dev/null))
    IFS=$OLDIFS
    [ -z "$FILES" ] && return

    # quote the metacharacters
    FILES=$FILES:q

    if [ -n "$ARG" ]; then
        modify-current-argument '$FILES'
    else
        LBUFFER="${LBUFFER%% #} $FILES"
    fi
}
zle -N image-selector
bindkey ${IMAGE_SELECTOR_KEY:-'^X^I'} image-selector
